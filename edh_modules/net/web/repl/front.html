<!DOCTYPE html>
<meta charset="utf-8" />

<head>
  <link rel="icon" type="image/png" href="/edh-fav.png?v=1" />
  <title>web REPL</title>
</head>

<body>
  <h3><img src="/edh-fav.png" alt="Đ" width="32" height="32" /> web REPL</h3>

  <div id="printOut"></div>
  <hr />
  <input type="checkbox" id="altSend"></input>
  <label for="altSend">Alt+Enter to</label>
  <button id="send">Send</button>
  <br />
  <textarea rows="5" id="readIn">dir</textarea>

  <style>
    body,
    textarea {
      background: #383831;
    }

    body {
      color: #7f8ed6;
      margin: 1px;
      padding: 1px 1px 20em 9pt;
    }

    textarea {
      color: #71ccae;
    }

    pre {
      font-size: 138%;
      color: #6ec73b;
    }

    #printOut {
      width: 90%;
      height: 60%;
      overflow: scroll;
    }

    #printOut>div {
      font-size: 80%;
      padding: 3pt 6pt;
      border: solid silver 1px;
      color: #c8da2a;
    }

    #readIn {
      margin: 6pt 3pt;
      width: 96%;
      resize: vertical;
    }
  </style>

  <script type="module">

    function getContentOf(url) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.onerror = reject;
        xhr.onload = () => resolve(xhr.responseText);
        xhr.send();
      });
    }

    (async () => {
      const divPrint = document.getElementById("printOut");

      function printOut(msg) {
        let printOutPane = document.createElement("pre");
        printOutPane.appendChild(document.createTextNode(msg));
        let printOutRecord = document.createElement("div");
        printOutRecord.appendChild(document.createTextNode("💬 " + new Date()));
        printOutRecord.appendChild(printOutPane);
        divPrint.appendChild(printOutRecord);
        divPrint.scrollTop = divPrint.scrollHeight;

      }

      const wsPort = await getContentOf("/:");
      const wsUrl = "ws://" + location.hostname + ":" + wsPort
        + location.search;
      const ws = new WebSocket(wsUrl);

      ws.onmessage = (me) => {
        if ("string" !== typeof me.data) {
          debugger;
          throw "WS printOut of type " + typeof me.data + " ?!";
        }
        printOut(me.data);
      };
      ws.onclose = () => {
        printOut('REPL disconnected.')
      }

      const chkAltSend = document.getElementById("altSend");
      const btnSend = document.getElementById("send");
      const txtReadIn = document.getElementById("readIn");

      function doSend() {
        if (ws.readyState !== WebSocket.OPEN) {
          alert(
            `You've been disconnected from the server.\n`
            + `Refresh the page to reconnect.`
          );
          return;
        }
        ws.send(txtReadIn.value);
        txtReadIn.value = "";
      }

      btnSend.onclick = doSend;
      window.addEventListener("keydown", function onKeyDown(evt) {
        if (evt.key === "Enter") {
          if (chkAltSend.checked && !evt.getModifierState("Alt")) {
            return true;
          }

          evt.preventDefault();
          evt.stopImmediatePropagation();
          doSend();
          return false;
        }
      }, { capture: true });

      txtReadIn.focus();
      txtReadIn.select();

    })();
  </script>
</body>